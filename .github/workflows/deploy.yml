# Minimal Working GitHub Actions Workflow
# Save this as: .github/workflows/build-and-deploy.yml

name: Build and Deploy to RunPod

on:
  push:
    branches: [main, master]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Debug - List files
      run: |
        echo "Repository structure:"
        find . -type f -name "*.py" -o -name "Dockerfile" -o -name "*.txt" | head -20
        echo ""
        echo "Gateway directory:"
        ls -la gateway/ 2>/dev/null || echo "Gateway directory not found"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Check required files
      run: |
        echo "Checking for required files..."
        
        # Check if gateway directory exists
        if [ ! -d "gateway" ]; then
          echo "âŒ 'gateway' directory not found"
          echo "Available directories:"
          ls -la
          exit 1
        fi
        
        # Check for rp_handler.py
        if [ ! -f "gateway/rp_handler.py" ]; then
          echo "âŒ gateway/rp_handler.py not found"
          echo "Files in gateway directory:"
          ls -la gateway/
          exit 1
        fi
        
        # Check for Dockerfile
        if [ ! -f "gateway/Dockerfile" ]; then
          echo "âŒ gateway/Dockerfile not found"
          echo "Files in gateway directory:"
          ls -la gateway/
          exit 1
        fi
        
        # Check for requirements.txt
        if [ ! -f "gateway/requirements.txt" ]; then
          echo "âš ï¸ gateway/requirements.txt not found, creating minimal one"
          echo "runpod>=1.5.0" > gateway/requirements.txt
          echo "requests>=2.31.0" >> gateway/requirements.txt
        fi
        
        echo "âœ… All required files found"

    - name: Build Docker image
      run: |
        cd gateway
        
        echo "Building Docker image..."
        docker buildx build \
          --platform linux/amd64 \
          --tag ghcr.io/${{ github.repository_owner }}/tts-engine/tts-gateway:latest \
          --tag ghcr.io/${{ github.repository_owner }}/tts-engine/tts-gateway:${{ github.sha }} \
          --push \
          .

    - name: Build summary
      run: |
        echo "ðŸŽ‰ Build completed successfully!"
        echo "ðŸ“¦ Image: ghcr.io/${{ github.repository_owner }}/tts-engine/tts-gateway:latest"
        echo "ðŸ”— SHA Tag: ghcr.io/${{ github.repository_owner }}/tts-engine/tts-gateway:${{ github.sha }}"
        echo ""
        echo "ðŸš€ Next steps:"
        echo "1. Go to RunPod Console"
        echo "2. Update your gateway endpoint image"
        echo "3. Test the deployment"
